
# Get table mappings from local files
locals {
  table_mappings      = file("${path.module}/../config/dms/table-mappings-somggn_raw_full_load_non_blob.json")
  blob_table_mappings = file("${path.module}/../config/dms/table-mappings-somggn_raw_full_load_blob.json")
  
  # ANO table mappings
  ano_table_mappings      = file("${path.module}/../config/dms/table-mappings-somano_raw_full_load_non_blob.json")
  ano_blob_table_mappings = file("${path.module}/../config/dms/table-mappings-somano_raw_full_load_blob.json")
  ano_revision_mappings   = file("${path.module}/../config/dms/table-mappings-somano_raw_revision_documents.json")

  # Additional CDC and full load table mappings
  somano_raw_cdc_mappings  = file("${path.module}/../config/dms/table-mappings-somano_raw_cdc.json")
  somano_raw_full_mappings = file("${path.module}/../config/dms/table-mappings-somano_raw_full.json")
  somggn_raw_cdc_mappings  = file("${path.module}/../config/dms/table-mappings-somggn_raw_cdc.json")
  somggn_raw_full_mappings = file("${path.module}/../config/dms/table-mappings-somggn_raw_full.json")
  somrbs_raw_cdc_mappings  = file("${path.module}/../config/dms/table-mappings-somrbs_raw_cdc.json")
  somrbs_raw_full_mappings = file("${path.module}/../config/dms/table-mappings-somrbs_raw_full.json")
  somwf3_raw_cdc_mappings  = file("${path.module}/../config/dms/table-mappings-somwf3_raw_cdc.json")
  somwf3_raw_full_mappings = file("${path.module}/../config/dms/table-mappings-somwf3_raw_full.json")
}

# Reference existing CloudWatch Log Group
data "aws_cloudwatch_log_group" "dms_task" {
  name = "/aws/dms/task/migration"
}

# DMS Replication Task
resource "aws_dms_replication_task" "migration" {
  migration_type           = "full-load"
  replication_instance_arn = data.aws_dms_replication_instance.main.replication_instance_arn
  replication_task_id      = "migration-task-esoms-ggn-non-blob-full"
  source_endpoint_arn      = aws_dms_endpoint.esom_ggn_oracle_source_endpoint.endpoint_arn
  target_endpoint_arn      = aws_dms_endpoint.s3_target_endpoint.endpoint_arn
  table_mappings           = local.table_mappings


  replication_task_settings = jsonencode({
    Logging = {
      EnableLogging = true
      EnableLogContext = true
      LogComponents = [
        { Severity = "LOGGER_SEVERITY_DEFAULT", Id = "TRANSFORMATION" },
        { Severity = "LOGGER_SEVERITY_DEFAULT", Id = "SOURCE_UNLOAD" },
        { Severity = "LOGGER_SEVERITY_DEFAULT", Id = "IO" },
        { Severity = "LOGGER_SEVERITY_DEFAULT", Id = "TARGET_LOAD" },
        { Severity = "LOGGER_SEVERITY_DEFAULT", Id = "PERFORMANCE" },
        { Severity = "LOGGER_SEVERITY_DEFAULT", Id = "SOURCE_CAPTURE" },
        { Severity = "LOGGER_SEVERITY_DEFAULT", Id = "SORTER" },
        { Severity = "LOGGER_SEVERITY_DEFAULT", Id = "REST_SERVER" },
        { Severity = "LOGGER_SEVERITY_DEFAULT", Id = "VALIDATOR_EXT" },
        { Severity = "LOGGER_SEVERITY_DEFAULT", Id = "TARGET_APPLY" },
        { Severity = "LOGGER_SEVERITY_DEFAULT", Id = "TASK_MANAGER" },
        { Severity = "LOGGER_SEVERITY_DEFAULT", Id = "TABLES_MANAGER" },
        { Severity = "LOGGER_SEVERITY_DEFAULT", Id = "METADATA_MANAGER" },
        { Severity = "LOGGER_SEVERITY_DEFAULT", Id = "FILE_FACTORY" },
        { Severity = "LOGGER_SEVERITY_DEFAULT", Id = "COMMON" },
        { Severity = "LOGGER_SEVERITY_DEFAULT", Id = "ADDONS" },
        { Severity = "LOGGER_SEVERITY_DEFAULT", Id = "DATA_STRUCTURE" },
        { Severity = "LOGGER_SEVERITY_DEFAULT", Id = "COMMUNICATION" },
        { Severity = "LOGGER_SEVERITY_DEFAULT", Id = "FILE_TRANSFER" }
      ]
    }
    StreamBufferSettings = {
      StreamBufferCount = 2
      CtrlStreamBufferSizeInMB = 16
      StreamBufferSizeInMB = 16
    }
    ErrorBehavior = {
      FailOnNoTablesCaptured = true
      ApplyErrorUpdatePolicy = "LOG_ERROR"
      FailOnTransactionConsistencyBreached = false
      RecoverableErrorThrottlingMax = 1800
      DataErrorEscalationPolicy = "SUSPEND_TABLE"
      ApplyErrorEscalationCount = 0
      RecoverableErrorStopRetryAfterThrottlingMax = true
      RecoverableErrorThrottling = true
      ApplyErrorFailOnTruncationDdl = false
      DataMaskingErrorPolicy = "STOP_TASK"
      DataTruncationErrorPolicy = "LOG_ERROR"
      ApplyErrorInsertPolicy = "LOG_ERROR"
      EventErrorPolicy = "IGNORE"
      ApplyErrorEscalationPolicy = "LOG_ERROR"
      RecoverableErrorCount = -1
      DataErrorEscalationCount = 0
      TableErrorEscalationPolicy = "STOP_TASK"
      RecoverableErrorInterval = 5
      ApplyErrorDeletePolicy = "IGNORE_RECORD"
      TableErrorEscalationCount = 0
      FullLoadIgnoreConflicts = true
      DataErrorPolicy = "LOG_ERROR"
      TableErrorPolicy = "SUSPEND_TABLE"
    }
    TTSettings = null
    FullLoadSettings = {
      CommitRate = 5000
      StopTaskCachedChangesApplied = false
      StopTaskCachedChangesNotApplied = false
      MaxFullLoadSubTasks = 4
      TransactionConsistencyTimeout = 600
      CreatePkAfterFullLoad = false
      TargetTablePrepMode = "DROP_AND_CREATE"
    }
    TargetMetadata = {
      ParallelApplyBufferSize = 0
      ParallelApplyQueuesPerThread = 0
      ParallelApplyThreads = 0
      TargetSchema = ""
      InlineLobMaxSize = 0
      ParallelLoadQueuesPerThread = 0
      SupportLobs = true
      LobChunkSize = 0
      TaskRecoveryTableEnabled = false
      ParallelLoadThreads = 0
      LobMaxSize = 63
      BatchApplyEnabled = false
      FullLobMode = false
      LimitedSizeLobMode = true
      LoadMaxFileSize = 0
      ParallelLoadBufferSize = 0
    }
    BeforeImageSettings = null
    ControlTablesSettings = {
      historyTimeslotInMinutes = 5
      HistoryTimeslotInMinutes = 5
      StatusTableEnabled = false
      SuspendedTablesTableEnabled = false
      HistoryTableEnabled = false
      ControlSchema = ""
      FullLoadExceptionTableEnabled = false
    }
    LoopbackPreventionSettings = null
    CharacterSetSettings = null
    FailTaskWhenCleanTaskResourceFailed = false
    ChangeProcessingTuning = {
      StatementCacheSize = 50
      CommitTimeout = 1
      RecoveryTimeout = -1
      BatchApplyPreserveTransaction = true
      BatchApplyTimeoutMin = 1
      BatchSplitSize = 0
      BatchApplyTimeoutMax = 30
      MinTransactionSize = 1000
      MemoryKeepTime = 30
      BatchApplyMemoryLimit = 1024
      MemoryLimitTotal = 2048
    }
    ChangeProcessingDdlHandlingPolicy = {
      HandleSourceTableDropped = true
      HandleSourceTableTruncated = true
      HandleSourceTableAltered = true
    }
    PostProcessingRules = null
    TimestampColumnName = "edl_load_date"
  })

  tags = {
    Name         = "migration-task"
    Environment  = var.environment
    Pod          = var.pod
    Businessunit = var.businessunit
  }

}



# Reference existing CloudWatch Log Group for blob task
data "aws_cloudwatch_log_group" "dms_blob_task" {
  name = "/aws/dms/task/blob-migration"
}

# DMS Blob Replication Task
resource "aws_dms_replication_task" "blob_migration" {
  migration_type           = "full-load"
  replication_instance_arn = data.aws_dms_replication_instance.main.replication_instance_arn
  replication_task_id      = "migration-task-esoms-ggn-blob-full"
  source_endpoint_arn      = aws_dms_endpoint.esom_ggn_oracle_source_endpoint.endpoint_arn
  target_endpoint_arn      = aws_dms_endpoint.s3_target_endpoint.endpoint_arn
  table_mappings           = local.blob_table_mappings

  replication_task_settings = jsonencode({
    Logging = {
      EnableLogging = true
      EnableLogContext = true
      LogComponents = [
        { Severity = "LOGGER_SEVERITY_DEFAULT", Id = "TRANSFORMATION" },
        { Severity = "LOGGER_SEVERITY_DEFAULT", Id = "SOURCE_UNLOAD" },
        { Severity = "LOGGER_SEVERITY_DEFAULT", Id = "IO" },
        { Severity = "LOGGER_SEVERITY_DEFAULT", Id = "TARGET_LOAD" },
        { Severity = "LOGGER_SEVERITY_DEFAULT", Id = "PERFORMANCE" },
        { Severity = "LOGGER_SEVERITY_DEFAULT", Id = "SOURCE_CAPTURE" },
        { Severity = "LOGGER_SEVERITY_DEFAULT", Id = "SORTER" },
        { Severity = "LOGGER_SEVERITY_DEFAULT", Id = "REST_SERVER" },
        { Severity = "LOGGER_SEVERITY_DEFAULT", Id = "VALIDATOR_EXT" },
        { Severity = "LOGGER_SEVERITY_DEFAULT", Id = "TARGET_APPLY" },
        { Severity = "LOGGER_SEVERITY_DEFAULT", Id = "TASK_MANAGER" },
        { Severity = "LOGGER_SEVERITY_DEFAULT", Id = "TABLES_MANAGER" },
        { Severity = "LOGGER_SEVERITY_DEFAULT", Id = "METADATA_MANAGER" },
        { Severity = "LOGGER_SEVERITY_DEFAULT", Id = "FILE_FACTORY" },
        { Severity = "LOGGER_SEVERITY_DEFAULT", Id = "COMMON" },
        { Severity = "LOGGER_SEVERITY_DEFAULT", Id = "ADDONS" },
        { Severity = "LOGGER_SEVERITY_DEFAULT", Id = "DATA_STRUCTURE" },
        { Severity = "LOGGER_SEVERITY_DEFAULT", Id = "COMMUNICATION" },
        { Severity = "LOGGER_SEVERITY_DEFAULT", Id = "FILE_TRANSFER" }
      ]
    }
    StreamBufferSettings = {
      StreamBufferCount = 2
      CtrlStreamBufferSizeInMB = 16
      StreamBufferSizeInMB = 16
    }
    ErrorBehavior = {
      FailOnNoTablesCaptured = true
      ApplyErrorUpdatePolicy = "LOG_ERROR"
      FailOnTransactionConsistencyBreached = false
      RecoverableErrorThrottlingMax = 1800
      DataErrorEscalationPolicy = "SUSPEND_TABLE"
      ApplyErrorEscalationCount = 0
      RecoverableErrorStopRetryAfterThrottlingMax = true
      RecoverableErrorThrottling = true
      ApplyErrorFailOnTruncationDdl = false
      DataMaskingErrorPolicy = "STOP_TASK"
      DataTruncationErrorPolicy = "LOG_ERROR"
      ApplyErrorInsertPolicy = "LOG_ERROR"
      EventErrorPolicy = "IGNORE"
      ApplyErrorEscalationPolicy = "LOG_ERROR"
      RecoverableErrorCount = -1
      DataErrorEscalationCount = 0
      TableErrorEscalationPolicy = "STOP_TASK"
      RecoverableErrorInterval = 5
      ApplyErrorDeletePolicy = "IGNORE_RECORD"
      TableErrorEscalationCount = 0
      FullLoadIgnoreConflicts = true
      DataErrorPolicy = "LOG_ERROR"
      TableErrorPolicy = "SUSPEND_TABLE"
    }
    TTSettings = null
    FullLoadSettings = {
      CommitRate = 5000
      StopTaskCachedChangesApplied = false
      StopTaskCachedChangesNotApplied = false
      MaxFullLoadSubTasks = 4
      TransactionConsistencyTimeout = 600
      CreatePkAfterFullLoad = false
      TargetTablePrepMode = "DROP_AND_CREATE"
    }
    TargetMetadata = {
      ParallelApplyBufferSize = 0
      ParallelApplyQueuesPerThread = 0
      ParallelApplyThreads = 0
      TargetSchema = ""
      InlineLobMaxSize = 0
      ParallelLoadQueuesPerThread = 0
      SupportLobs = true
      LobChunkSize = 0
      TaskRecoveryTableEnabled = false
      ParallelLoadThreads = 0
      LobMaxSize = 150000
      BatchApplyEnabled = false
      FullLobMode = false
      LimitedSizeLobMode = true
      LoadMaxFileSize = 0
      ParallelLoadBufferSize = 0
    }
    BeforeImageSettings = null
    ControlTablesSettings = {
      historyTimeslotInMinutes = 5
      HistoryTimeslotInMinutes = 5
      StatusTableEnabled = false
      SuspendedTablesTableEnabled = false
      HistoryTableEnabled = false
      ControlSchema = ""
      FullLoadExceptionTableEnabled = false
    }
    LoopbackPreventionSettings = null
    CharacterSetSettings = null
    FailTaskWhenCleanTaskResourceFailed = false
    ChangeProcessingTuning = {
      StatementCacheSize = 50
      CommitTimeout = 1
      RecoveryTimeout = -1
      BatchApplyPreserveTransaction = true
      BatchApplyTimeoutMin = 1
      BatchSplitSize = 0
      BatchApplyTimeoutMax = 30
      MinTransactionSize = 1000
      MemoryKeepTime = 30
      BatchApplyMemoryLimit = 1024
      MemoryLimitTotal = 2048
    }
    ChangeProcessingDdlHandlingPolicy = {
      HandleSourceTableDropped = true
      HandleSourceTableTruncated = true
      HandleSourceTableAltered = true
    }
    PostProcessingRules = null
    TimestampColumnName = "edl_load_date"
  })

  tags = {
    Name         = "blob-migration-task"
    Environment  = var.environment
    Pod          = var.pod
    Businessunit = var.businessunit
  }

}

# DMS ANO Non-Blob Replication Task
resource "aws_dms_replication_task" "ano_migration" {
  migration_type           = "full-load"
  replication_instance_arn = data.aws_dms_replication_instance.main.replication_instance_arn
  replication_task_id      = "migration-task-esoms-ano-non-blob-full"
  source_endpoint_arn      = aws_dms_endpoint.esom_ano_oracle_source_endpoint.endpoint_arn
  target_endpoint_arn      = aws_dms_endpoint.s3_target_endpoint.endpoint_arn
  table_mappings           = local.ano_table_mappings

  replication_task_settings = jsonencode({
    Logging = {
      EnableLogging = true
      EnableLogContext = true
      LogComponents = [
        { Severity = "LOGGER_SEVERITY_DEFAULT", Id = "TRANSFORMATION" },
        { Severity = "LOGGER_SEVERITY_DEFAULT", Id = "SOURCE_UNLOAD" },
        { Severity = "LOGGER_SEVERITY_DEFAULT", Id = "IO" },
        { Severity = "LOGGER_SEVERITY_DEFAULT", Id = "TARGET_LOAD" },
        { Severity = "LOGGER_SEVERITY_DEFAULT", Id = "PERFORMANCE" },
        { Severity = "LOGGER_SEVERITY_DEFAULT", Id = "SOURCE_CAPTURE" },
        { Severity = "LOGGER_SEVERITY_DEFAULT", Id = "SORTER" },
        { Severity = "LOGGER_SEVERITY_DEFAULT", Id = "REST_SERVER" },
        { Severity = "LOGGER_SEVERITY_DEFAULT", Id = "VALIDATOR_EXT" },
        { Severity = "LOGGER_SEVERITY_DEFAULT", Id = "TARGET_APPLY" },
        { Severity = "LOGGER_SEVERITY_DEFAULT", Id = "TASK_MANAGER" },
        { Severity = "LOGGER_SEVERITY_DEFAULT", Id = "TABLES_MANAGER" },
        { Severity = "LOGGER_SEVERITY_DEFAULT", Id = "METADATA_MANAGER" },
        { Severity = "LOGGER_SEVERITY_DEFAULT", Id = "FILE_FACTORY" },
        { Severity = "LOGGER_SEVERITY_DEFAULT", Id = "COMMON" },
        { Severity = "LOGGER_SEVERITY_DEFAULT", Id = "ADDONS" },
        { Severity = "LOGGER_SEVERITY_DEFAULT", Id = "DATA_STRUCTURE" },
        { Severity = "LOGGER_SEVERITY_DEFAULT", Id = "COMMUNICATION" },
        { Severity = "LOGGER_SEVERITY_DEFAULT", Id = "FILE_TRANSFER" }
      ]
    }
    StreamBufferSettings = {
      StreamBufferCount = 2
      CtrlStreamBufferSizeInMB = 16
      StreamBufferSizeInMB = 16
    }
    ErrorBehavior = {
      FailOnNoTablesCaptured = true
      ApplyErrorUpdatePolicy = "LOG_ERROR"
      FailOnTransactionConsistencyBreached = false
      RecoverableErrorThrottlingMax = 1800
      DataErrorEscalationPolicy = "SUSPEND_TABLE"
      ApplyErrorEscalationCount = 0
      RecoverableErrorStopRetryAfterThrottlingMax = true
      RecoverableErrorThrottling = true
      ApplyErrorFailOnTruncationDdl = false
      DataMaskingErrorPolicy = "STOP_TASK"
      DataTruncationErrorPolicy = "LOG_ERROR"
      ApplyErrorInsertPolicy = "LOG_ERROR"
      EventErrorPolicy = "IGNORE"
      ApplyErrorEscalationPolicy = "LOG_ERROR"
      RecoverableErrorCount = -1
      DataErrorEscalationCount = 0
      TableErrorEscalationPolicy = "STOP_TASK"
      RecoverableErrorInterval = 5
      ApplyErrorDeletePolicy = "IGNORE_RECORD"
      TableErrorEscalationCount = 0
      FullLoadIgnoreConflicts = true
      DataErrorPolicy = "LOG_ERROR"
      TableErrorPolicy = "SUSPEND_TABLE"
    }
    TTSettings = null
    FullLoadSettings = {
      CommitRate = 5000
      StopTaskCachedChangesApplied = false
      StopTaskCachedChangesNotApplied = false
      MaxFullLoadSubTasks = 4
      TransactionConsistencyTimeout = 600
      CreatePkAfterFullLoad = false
      TargetTablePrepMode = "DO_NOTHING"
    }
    TargetMetadata = {
      ParallelApplyBufferSize = 0
      ParallelApplyQueuesPerThread = 0
      ParallelApplyThreads = 0
      TargetSchema = ""
      InlineLobMaxSize = 0
      ParallelLoadQueuesPerThread = 0
      SupportLobs = true
      LobChunkSize = 0
      TaskRecoveryTableEnabled = false
      ParallelLoadThreads = 0
      LobMaxSize = 32
      BatchApplyEnabled = false
      FullLobMode = false
      LimitedSizeLobMode = true
      LoadMaxFileSize = 0
      ParallelLoadBufferSize = 0
    }
    BeforeImageSettings = null
    ControlTablesSettings = {
      historyTimeslotInMinutes = 5
      HistoryTimeslotInMinutes = 5
      StatusTableEnabled = false
      SuspendedTablesTableEnabled = false
      HistoryTableEnabled = false
      ControlSchema = ""
      FullLoadExceptionTableEnabled = false
    }
    LoopbackPreventionSettings = null
    CharacterSetSettings = null
    FailTaskWhenCleanTaskResourceFailed = false
    ChangeProcessingTuning = {
      StatementCacheSize = 50
      CommitTimeout = 1
      RecoveryTimeout = -1
      BatchApplyPreserveTransaction = true
      BatchApplyTimeoutMin = 1
      BatchSplitSize = 0
      BatchApplyTimeoutMax = 30
      MinTransactionSize = 1000
      MemoryKeepTime = 30
      BatchApplyMemoryLimit = 1024
      MemoryLimitTotal = 2048
    }
    ChangeProcessingDdlHandlingPolicy = {
      HandleSourceTableDropped = true
      HandleSourceTableTruncated = true
      HandleSourceTableAltered = true
    }
    PostProcessingRules = null
    TimestampColumnName = "edl_load_date"
  })

  tags = {
    Name         = "ano-migration-task"
    Environment  = var.environment
    Pod          = var.pod
    Businessunit = var.businessunit
  }

}

# DMS ANO Blob Replication Task
resource "aws_dms_replication_task" "ano_blob_migration" {
  migration_type           = "full-load"
  replication_instance_arn = data.aws_dms_replication_instance.main.replication_instance_arn
  replication_task_id      = "migration-task-esoms-ano-blob-full"
  source_endpoint_arn      = aws_dms_endpoint.esom_ano_oracle_source_endpoint.endpoint_arn
  target_endpoint_arn      = aws_dms_endpoint.s3_target_endpoint.endpoint_arn
  table_mappings           = local.ano_blob_table_mappings

  replication_task_settings = jsonencode({
    Logging = {
      EnableLogging = true
      EnableLogContext = false
      LogComponents = [
        { Severity = "LOGGER_SEVERITY_DEFAULT", Id = "TRANSFORMATION" },
        { Severity = "LOGGER_SEVERITY_DEFAULT", Id = "SOURCE_UNLOAD" },
        { Severity = "LOGGER_SEVERITY_DEFAULT", Id = "IO" },
        { Severity = "LOGGER_SEVERITY_DEFAULT", Id = "TARGET_LOAD" },
        { Severity = "LOGGER_SEVERITY_DEFAULT", Id = "PERFORMANCE" },
        { Severity = "LOGGER_SEVERITY_DEFAULT", Id = "SOURCE_CAPTURE" },
        { Severity = "LOGGER_SEVERITY_DEFAULT", Id = "SORTER" },
        { Severity = "LOGGER_SEVERITY_DEFAULT", Id = "REST_SERVER" },
        { Severity = "LOGGER_SEVERITY_DEFAULT", Id = "VALIDATOR_EXT" },
        { Severity = "LOGGER_SEVERITY_DEFAULT", Id = "TARGET_APPLY" },
        { Severity = "LOGGER_SEVERITY_DEFAULT", Id = "TASK_MANAGER" },
        { Severity = "LOGGER_SEVERITY_DEFAULT", Id = "TABLES_MANAGER" },
        { Severity = "LOGGER_SEVERITY_DEFAULT", Id = "METADATA_MANAGER" },
        { Severity = "LOGGER_SEVERITY_DEFAULT", Id = "FILE_FACTORY" },
        { Severity = "LOGGER_SEVERITY_DEFAULT", Id = "COMMON" },
        { Severity = "LOGGER_SEVERITY_DEFAULT", Id = "ADDONS" },
        { Severity = "LOGGER_SEVERITY_DEFAULT", Id = "DATA_STRUCTURE" },
        { Severity = "LOGGER_SEVERITY_DEFAULT", Id = "COMMUNICATION" },
        { Severity = "LOGGER_SEVERITY_DEFAULT", Id = "FILE_TRANSFER" }
      ]
    }
    StreamBufferSettings = {
      StreamBufferCount = 2
      CtrlStreamBufferSizeInMB = 16
      StreamBufferSizeInMB = 16
    }
    ErrorBehavior = {
      FailOnNoTablesCaptured = true
      ApplyErrorUpdatePolicy = "LOG_ERROR"
      FailOnTransactionConsistencyBreached = false
      RecoverableErrorThrottlingMax = 1800
      DataErrorEscalationPolicy = "SUSPEND_TABLE"
      ApplyErrorEscalationCount = 0
      RecoverableErrorStopRetryAfterThrottlingMax = true
      RecoverableErrorThrottling = true
      ApplyErrorFailOnTruncationDdl = false
      DataMaskingErrorPolicy = "STOP_TASK"
      DataTruncationErrorPolicy = "LOG_ERROR"
      ApplyErrorInsertPolicy = "LOG_ERROR"
      EventErrorPolicy = "IGNORE"
      ApplyErrorEscalationPolicy = "LOG_ERROR"
      RecoverableErrorCount = -1
      DataErrorEscalationCount = 0
      TableErrorEscalationPolicy = "STOP_TASK"
      RecoverableErrorInterval = 5
      ApplyErrorDeletePolicy = "IGNORE_RECORD"
      TableErrorEscalationCount = 0
      FullLoadIgnoreConflicts = true
      DataErrorPolicy = "LOG_ERROR"
      TableErrorPolicy = "SUSPEND_TABLE"
    }
    TTSettings = null
    FullLoadSettings = {
      CommitRate = 5000
      StopTaskCachedChangesApplied = false
      StopTaskCachedChangesNotApplied = false
      MaxFullLoadSubTasks = 4
      TransactionConsistencyTimeout = 600
      CreatePkAfterFullLoad = false
      TargetTablePrepMode = "DROP_AND_CREATE"
    }
    TargetMetadata = {
      ParallelApplyBufferSize = 0
      ParallelApplyQueuesPerThread = 0
      ParallelApplyThreads = 0
      TargetSchema = ""
      InlineLobMaxSize = 0
      ParallelLoadQueuesPerThread = 0
      SupportLobs = true
      LobChunkSize = 0
      TaskRecoveryTableEnabled = false
      ParallelLoadThreads = 0
      LobMaxSize = 150000
      BatchApplyEnabled = false
      FullLobMode = false
      LimitedSizeLobMode = true
      LoadMaxFileSize = 0
      ParallelLoadBufferSize = 0
    }
    BeforeImageSettings = null
    ControlTablesSettings = {
      historyTimeslotInMinutes = 5
      HistoryTimeslotInMinutes = 5
      StatusTableEnabled = false
      SuspendedTablesTableEnabled = false
      HistoryTableEnabled = false
      ControlSchema = ""
      FullLoadExceptionTableEnabled = false
    }
    LoopbackPreventionSettings = null
    CharacterSetSettings = null
    FailTaskWhenCleanTaskResourceFailed = false
    ChangeProcessingTuning = {
      StatementCacheSize = 50
      CommitTimeout = 1
      RecoveryTimeout = -1
      BatchApplyPreserveTransaction = true
      BatchApplyTimeoutMin = 1
      BatchSplitSize = 0
      BatchApplyTimeoutMax = 30
      MinTransactionSize = 1000
      MemoryKeepTime = 30
      BatchApplyMemoryLimit = 1024
      MemoryLimitTotal = 2048
    }
    ChangeProcessingDdlHandlingPolicy = {
      HandleSourceTableDropped = true
      HandleSourceTableTruncated = true
      HandleSourceTableAltered = true
    }
    PostProcessingRules = null
    TimestampColumnName = "edl_load_date"
  })

  tags = {
    Name         = "ano-blob-migration-task"
    Environment  = var.environment
    Pod          = var.pod
    Businessunit = var.businessunit
  }

}

# DMS ANO Revision Documents Replication Task
resource "aws_dms_replication_task" "ano_revision_migration" {
  migration_type           = "full-load"
  replication_instance_arn = data.aws_dms_replication_instance.main.replication_instance_arn
  replication_task_id      = "migration-task-esoms-ano-revision-docs-full"
  source_endpoint_arn      = aws_dms_endpoint.esom_ano_oracle_source_endpoint.endpoint_arn
  target_endpoint_arn      = aws_dms_endpoint.s3_target_endpoint.endpoint_arn
  table_mappings           = local.ano_revision_mappings

  replication_task_settings = jsonencode({
    Logging = {
      EnableLogging = true
      EnableLogContext = true
      LogComponents = [
        { Severity = "LOGGER_SEVERITY_DEFAULT", Id = "TRANSFORMATION" },
        { Severity = "LOGGER_SEVERITY_DEFAULT", Id = "SOURCE_UNLOAD" },
        { Severity = "LOGGER_SEVERITY_DEFAULT", Id = "IO" },
        { Severity = "LOGGER_SEVERITY_DEFAULT", Id = "TARGET_LOAD" },
        { Severity = "LOGGER_SEVERITY_DEFAULT", Id = "PERFORMANCE" },
        { Severity = "LOGGER_SEVERITY_DEFAULT", Id = "SOURCE_CAPTURE" },
        { Severity = "LOGGER_SEVERITY_DEFAULT", Id = "SORTER" },
        { Severity = "LOGGER_SEVERITY_DEFAULT", Id = "REST_SERVER" },
        { Severity = "LOGGER_SEVERITY_DEFAULT", Id = "VALIDATOR_EXT" },
        { Severity = "LOGGER_SEVERITY_DEFAULT", Id = "TARGET_APPLY" },
        { Severity = "LOGGER_SEVERITY_DEFAULT", Id = "TASK_MANAGER" },
        { Severity = "LOGGER_SEVERITY_DEFAULT", Id = "TABLES_MANAGER" },
        { Severity = "LOGGER_SEVERITY_DEFAULT", Id = "METADATA_MANAGER" },
        { Severity = "LOGGER_SEVERITY_DEFAULT", Id = "FILE_FACTORY" },
        { Severity = "LOGGER_SEVERITY_DEFAULT", Id = "COMMON" },
        { Severity = "LOGGER_SEVERITY_DEFAULT", Id = "ADDONS" },
        { Severity = "LOGGER_SEVERITY_DEFAULT", Id = "DATA_STRUCTURE" },
        { Severity = "LOGGER_SEVERITY_DEFAULT", Id = "COMMUNICATION" },
        { Severity = "LOGGER_SEVERITY_DEFAULT", Id = "FILE_TRANSFER" }
      ]
    }
    StreamBufferSettings = {
      StreamBufferCount = 2
      CtrlStreamBufferSizeInMB = 16
      StreamBufferSizeInMB = 16
    }
    ErrorBehavior = {
      FailOnNoTablesCaptured = true
      ApplyErrorUpdatePolicy = "LOG_ERROR"
      FailOnTransactionConsistencyBreached = false
      RecoverableErrorThrottlingMax = 1800
      DataErrorEscalationPolicy = "SUSPEND_TABLE"
      ApplyErrorEscalationCount = 0
      RecoverableErrorStopRetryAfterThrottlingMax = true
      RecoverableErrorThrottling = true
      ApplyErrorFailOnTruncationDdl = false
      DataMaskingErrorPolicy = "STOP_TASK"
      DataTruncationErrorPolicy = "LOG_ERROR"
      ApplyErrorInsertPolicy = "LOG_ERROR"
      EventErrorPolicy = "IGNORE"
      ApplyErrorEscalationPolicy = "LOG_ERROR"
      RecoverableErrorCount = -1
      DataErrorEscalationCount = 0
      TableErrorEscalationPolicy = "STOP_TASK"
      RecoverableErrorInterval = 5
      ApplyErrorDeletePolicy = "IGNORE_RECORD"
      TableErrorEscalationCount = 0
      FullLoadIgnoreConflicts = true
      DataErrorPolicy = "LOG_ERROR"
      TableErrorPolicy = "SUSPEND_TABLE"
    }
    TTSettings = null
    FullLoadSettings = {
      CommitRate = 5000
      StopTaskCachedChangesApplied = false
      StopTaskCachedChangesNotApplied = false
      MaxFullLoadSubTasks = 4
      TransactionConsistencyTimeout = 600
      CreatePkAfterFullLoad = false
      TargetTablePrepMode = "DROP_AND_CREATE"
    }
    TargetMetadata = {
      ParallelApplyBufferSize = 0
      ParallelApplyQueuesPerThread = 0
      ParallelApplyThreads = 0
      TargetSchema = ""
      InlineLobMaxSize = 0
      ParallelLoadQueuesPerThread = 0
      SupportLobs = true
      LobChunkSize = 0
      TaskRecoveryTableEnabled = false
      ParallelLoadThreads = 0
      LobMaxSize = 1000
      BatchApplyEnabled = false
      FullLobMode = false
      LimitedSizeLobMode = true
      LoadMaxFileSize = 0
      ParallelLoadBufferSize = 0
    }
    BeforeImageSettings = null
    ControlTablesSettings = {
      historyTimeslotInMinutes = 5
      HistoryTimeslotInMinutes = 5
      StatusTableEnabled = false
      SuspendedTablesTableEnabled = false
      HistoryTableEnabled = false
      ControlSchema = ""
      FullLoadExceptionTableEnabled = false
    }
    LoopbackPreventionSettings = null
    CharacterSetSettings = null
    FailTaskWhenCleanTaskResourceFailed = false
    ChangeProcessingTuning = {
      StatementCacheSize = 50
      CommitTimeout = 1
      RecoveryTimeout = -1
      BatchApplyPreserveTransaction = true
      BatchApplyTimeoutMin = 1
      BatchSplitSize = 0
      BatchApplyTimeoutMax = 30
      MinTransactionSize = 1000
      MemoryKeepTime = 30
      BatchApplyMemoryLimit = 1024
      MemoryLimitTotal = 2048
    }
    ChangeProcessingDdlHandlingPolicy = {
      HandleSourceTableDropped = true
      HandleSourceTableTruncated = true
      HandleSourceTableAltered = true
    }
    PostProcessingRules = null
    TimestampColumnName = "edl_load_date"
  })

  tags = {
    Name         = "ano-revision-migration-task"
    Environment  = var.environment
    Pod          = var.pod
    Businessunit = var.businessunit
  }

}

# DMS SOMANO Raw CDC Replication Task
resource "aws_dms_replication_task" "somano_raw_cdc_migration" {
  migration_type           = "cdc"
  replication_instance_arn = data.aws_dms_replication_instance.main.replication_instance_arn
  replication_task_id      = "migration-task-esoms-ano-raw-cdc"
  source_endpoint_arn      = aws_dms_endpoint.esom_ano_oracle_source_endpoint.endpoint_arn
  target_endpoint_arn      = aws_dms_endpoint.s3_target_endpoint.endpoint_arn
  table_mappings           = local.somano_raw_cdc_mappings

  replication_task_settings = jsonencode({
    Logging = {
      EnableLogging = true
      EnableLogContext = true
      LogComponents = [
        { Severity = "LOGGER_SEVERITY_DEFAULT", Id = "TRANSFORMATION" },
        { Severity = "LOGGER_SEVERITY_DEFAULT", Id = "SOURCE_UNLOAD" },
        { Severity = "LOGGER_SEVERITY_DEFAULT", Id = "IO" },
        { Severity = "LOGGER_SEVERITY_DEFAULT", Id = "TARGET_LOAD" },
        { Severity = "LOGGER_SEVERITY_DEFAULT", Id = "PERFORMANCE" },
        { Severity = "LOGGER_SEVERITY_DEFAULT", Id = "SOURCE_CAPTURE" },
        { Severity = "LOGGER_SEVERITY_DEFAULT", Id = "SORTER" },
        { Severity = "LOGGER_SEVERITY_DEFAULT", Id = "REST_SERVER" },
        { Severity = "LOGGER_SEVERITY_DEFAULT", Id = "VALIDATOR_EXT" },
        { Severity = "LOGGER_SEVERITY_DEFAULT", Id = "TARGET_APPLY" },
        { Severity = "LOGGER_SEVERITY_DEFAULT", Id = "TASK_MANAGER" },
        { Severity = "LOGGER_SEVERITY_DEFAULT", Id = "TABLES_MANAGER" },
        { Severity = "LOGGER_SEVERITY_DEFAULT", Id = "METADATA_MANAGER" },
        { Severity = "LOGGER_SEVERITY_DEFAULT", Id = "FILE_FACTORY" },
        { Severity = "LOGGER_SEVERITY_DEFAULT", Id = "COMMON" },
        { Severity = "LOGGER_SEVERITY_DEFAULT", Id = "ADDONS" },
        { Severity = "LOGGER_SEVERITY_DEFAULT", Id = "DATA_STRUCTURE" },
        { Severity = "LOGGER_SEVERITY_DEFAULT", Id = "COMMUNICATION" },
        { Severity = "LOGGER_SEVERITY_DEFAULT", Id = "FILE_TRANSFER" }
      ]
    }
    StreamBufferSettings = {
      StreamBufferCount = 2
      CtrlStreamBufferSizeInMB = 16
      StreamBufferSizeInMB = 16
    }
    ErrorBehavior = {
      FailOnNoTablesCaptured = true
      ApplyErrorUpdatePolicy = "LOG_ERROR"
      FailOnTransactionConsistencyBreached = false
      RecoverableErrorThrottlingMax = 1800
      DataErrorEscalationPolicy = "SUSPEND_TABLE"
      ApplyErrorEscalationCount = 0
      RecoverableErrorStopRetryAfterThrottlingMax = true
      RecoverableErrorThrottling = true
      ApplyErrorFailOnTruncationDdl = false
      DataMaskingErrorPolicy = "STOP_TASK"
      DataTruncationErrorPolicy = "LOG_ERROR"
      ApplyErrorInsertPolicy = "LOG_ERROR"
      EventErrorPolicy = "IGNORE"
      ApplyErrorEscalationPolicy = "LOG_ERROR"
      RecoverableErrorCount = -1
      DataErrorEscalationCount = 0
      TableErrorEscalationPolicy = "STOP_TASK"
      RecoverableErrorInterval = 5
      ApplyErrorDeletePolicy = "IGNORE_RECORD"
      TableErrorEscalationCount = 0
      FullLoadIgnoreConflicts = true
      DataErrorPolicy = "LOG_ERROR"
      TableErrorPolicy = "SUSPEND_TABLE"
    }
    TTSettings = null
    FullLoadSettings = {
      CommitRate = 5000
      StopTaskCachedChangesApplied = false
      StopTaskCachedChangesNotApplied = false
      MaxFullLoadSubTasks = 4
      TransactionConsistencyTimeout = 600
      CreatePkAfterFullLoad = false
      TargetTablePrepMode = "DO_NOTHING"
    }
    TargetMetadata = {
      ParallelApplyBufferSize = 0
      ParallelApplyQueuesPerThread = 0
      ParallelApplyThreads = 0
      TargetSchema = ""
      InlineLobMaxSize = 0
      ParallelLoadQueuesPerThread = 0
      SupportLobs = true
      LobChunkSize = 0
      TaskRecoveryTableEnabled = false
      ParallelLoadThreads = 0
      LobMaxSize = 32
      BatchApplyEnabled = false
      FullLobMode = false
      LimitedSizeLobMode = true
      LoadMaxFileSize = 0
      ParallelLoadBufferSize = 0
    }
    BeforeImageSettings = null
    ControlTablesSettings = {
      historyTimeslotInMinutes = 5
      HistoryTimeslotInMinutes = 5
      StatusTableEnabled = false
      SuspendedTablesTableEnabled = false
      HistoryTableEnabled = false
      ControlSchema = ""
      FullLoadExceptionTableEnabled = false
    }
    LoopbackPreventionSettings = null
    CharacterSetSettings = null
    FailTaskWhenCleanTaskResourceFailed = false
    ChangeProcessingTuning = {
      StatementCacheSize = 50
      CommitTimeout = 1
      RecoveryTimeout = -1
      BatchApplyPreserveTransaction = true
      BatchApplyTimeoutMin = 1
      BatchSplitSize = 0
      BatchApplyTimeoutMax = 30
      MinTransactionSize = 1000
      MemoryKeepTime = 30
      BatchApplyMemoryLimit = 1024
      MemoryLimitTotal = 2048
    }
    ChangeProcessingDdlHandlingPolicy = {
      HandleSourceTableDropped = true
      HandleSourceTableTruncated = true
      HandleSourceTableAltered = true
    }
    PostProcessingRules = null
    TimestampColumnName = "edl_load_date"
  })

  tags = {
    Name         = "somano-raw-cdc-migration-task"
    Environment  = var.environment
    Pod          = var.pod
    Businessunit = var.businessunit
  }
}

# DMS SOMANO Raw Full Load Replication Task
resource "aws_dms_replication_task" "somano_raw_full_migration" {
  migration_type           = "full-load"
  replication_instance_arn = data.aws_dms_replication_instance.main.replication_instance_arn
  replication_task_id      = "migration-task-esoms-ano-raw-full"
  source_endpoint_arn      = aws_dms_endpoint.esom_ano_oracle_source_endpoint.endpoint_arn
  target_endpoint_arn      = aws_dms_endpoint.s3_target_endpoint.endpoint_arn
  table_mappings           = local.somano_raw_full_mappings

  replication_task_settings = jsonencode({
    Logging = {
      EnableLogging = true
      EnableLogContext = true
      LogComponents = [
        { Severity = "LOGGER_SEVERITY_DEFAULT", Id = "TRANSFORMATION" },
        { Severity = "LOGGER_SEVERITY_DEFAULT", Id = "SOURCE_UNLOAD" },
        { Severity = "LOGGER_SEVERITY_DEFAULT", Id = "IO" },
        { Severity = "LOGGER_SEVERITY_DEFAULT", Id = "TARGET_LOAD" },
        { Severity = "LOGGER_SEVERITY_DEFAULT", Id = "PERFORMANCE" },
        { Severity = "LOGGER_SEVERITY_DEFAULT", Id = "SOURCE_CAPTURE" },
        { Severity = "LOGGER_SEVERITY_DEFAULT", Id = "SORTER" },
        { Severity = "LOGGER_SEVERITY_DEFAULT", Id = "REST_SERVER" },
        { Severity = "LOGGER_SEVERITY_DEFAULT", Id = "VALIDATOR_EXT" },
        { Severity = "LOGGER_SEVERITY_DEFAULT", Id = "TARGET_APPLY" },
        { Severity = "LOGGER_SEVERITY_DEFAULT", Id = "TASK_MANAGER" },
        { Severity = "LOGGER_SEVERITY_DEFAULT", Id = "TABLES_MANAGER" },
        { Severity = "LOGGER_SEVERITY_DEFAULT", Id = "METADATA_MANAGER" },
        { Severity = "LOGGER_SEVERITY_DEFAULT", Id = "FILE_FACTORY" },
        { Severity = "LOGGER_SEVERITY_DEFAULT", Id = "COMMON" },
        { Severity = "LOGGER_SEVERITY_DEFAULT", Id = "ADDONS" },
        { Severity = "LOGGER_SEVERITY_DEFAULT", Id = "DATA_STRUCTURE" },
        { Severity = "LOGGER_SEVERITY_DEFAULT", Id = "COMMUNICATION" },
        { Severity = "LOGGER_SEVERITY_DEFAULT", Id = "FILE_TRANSFER" }
      ]
    }
    StreamBufferSettings = {
      StreamBufferCount = 2
      CtrlStreamBufferSizeInMB = 16
      StreamBufferSizeInMB = 16
    }
    ErrorBehavior = {
      FailOnNoTablesCaptured = true
      ApplyErrorUpdatePolicy = "LOG_ERROR"
      FailOnTransactionConsistencyBreached = false
      RecoverableErrorThrottlingMax = 1800
      DataErrorEscalationPolicy = "SUSPEND_TABLE"
      ApplyErrorEscalationCount = 0
      RecoverableErrorStopRetryAfterThrottlingMax = true
      RecoverableErrorThrottling = true
      ApplyErrorFailOnTruncationDdl = false
      DataMaskingErrorPolicy = "STOP_TASK"
      DataTruncationErrorPolicy = "LOG_ERROR"
      ApplyErrorInsertPolicy = "LOG_ERROR"
      EventErrorPolicy = "IGNORE"
      ApplyErrorEscalationPolicy = "LOG_ERROR"
      RecoverableErrorCount = -1
      DataErrorEscalationCount = 0
      TableErrorEscalationPolicy = "STOP_TASK"
      RecoverableErrorInterval = 5
      ApplyErrorDeletePolicy = "IGNORE_RECORD"
      TableErrorEscalationCount = 0
      FullLoadIgnoreConflicts = true
      DataErrorPolicy = "LOG_ERROR"
      TableErrorPolicy = "SUSPEND_TABLE"
    }
    TTSettings = null
    FullLoadSettings = {
      CommitRate = 5000
      StopTaskCachedChangesApplied = false
      StopTaskCachedChangesNotApplied = false
      MaxFullLoadSubTasks = 4
      TransactionConsistencyTimeout = 600
      CreatePkAfterFullLoad = false
      TargetTablePrepMode = "DROP_AND_CREATE"
    }
    TargetMetadata = {
      ParallelApplyBufferSize = 0
      ParallelApplyQueuesPerThread = 0
      ParallelApplyThreads = 0
      TargetSchema = ""
      InlineLobMaxSize = 0
      ParallelLoadQueuesPerThread = 0
      SupportLobs = true
      LobChunkSize = 0
      TaskRecoveryTableEnabled = false
      ParallelLoadThreads = 0
      LobMaxSize = 32
      BatchApplyEnabled = false
      FullLobMode = false
      LimitedSizeLobMode = true
      LoadMaxFileSize = 0
      ParallelLoadBufferSize = 0
    }
    BeforeImageSettings = null
    ControlTablesSettings = {
      historyTimeslotInMinutes = 5
      HistoryTimeslotInMinutes = 5
      StatusTableEnabled = false
      SuspendedTablesTableEnabled = false
      HistoryTableEnabled = false
      ControlSchema = ""
      FullLoadExceptionTableEnabled = false
    }
    LoopbackPreventionSettings = null
    CharacterSetSettings = null
    FailTaskWhenCleanTaskResourceFailed = false
    ChangeProcessingTuning = {
      StatementCacheSize = 50
      CommitTimeout = 1
      RecoveryTimeout = -1
      BatchApplyPreserveTransaction = true
      BatchApplyTimeoutMin = 1
      BatchSplitSize = 0
      BatchApplyTimeoutMax = 30
      MinTransactionSize = 1000
      MemoryKeepTime = 30
      BatchApplyMemoryLimit = 1024
      MemoryLimitTotal = 2048
    }
    ChangeProcessingDdlHandlingPolicy = {
      HandleSourceTableDropped = true
      HandleSourceTableTruncated = true
      HandleSourceTableAltered = true
    }
    PostProcessingRules = null
    TimestampColumnName = "edl_load_date"
  })

  tags = {
    Name         = "somano-raw-full-migration-task"
    Environment  = var.environment
    Pod          = var.pod
    Businessunit = var.businessunit
  }
}

# DMS SOMGGN Raw CDC Replication Task
resource "aws_dms_replication_task" "somggn_raw_cdc_migration" {
  migration_type           = "cdc"
  replication_instance_arn = data.aws_dms_replication_instance.main.replication_instance_arn
  replication_task_id      = "migration-task-esoms-ggn-raw-cdc"
  source_endpoint_arn      = aws_dms_endpoint.esom_ggn_oracle_source_endpoint.endpoint_arn
  target_endpoint_arn      = aws_dms_endpoint.s3_target_endpoint.endpoint_arn
  table_mappings           = local.somggn_raw_cdc_mappings

  replication_task_settings = jsonencode({
    Logging = {
      EnableLogging = true
      EnableLogContext = true
      LogComponents = [
        { Severity = "LOGGER_SEVERITY_DEFAULT", Id = "TRANSFORMATION" },
        { Severity = "LOGGER_SEVERITY_DEFAULT", Id = "SOURCE_UNLOAD" },
        { Severity = "LOGGER_SEVERITY_DEFAULT", Id = "IO" },
        { Severity = "LOGGER_SEVERITY_DEFAULT", Id = "TARGET_LOAD" },
        { Severity = "LOGGER_SEVERITY_DEFAULT", Id = "PERFORMANCE" },
        { Severity = "LOGGER_SEVERITY_DEFAULT", Id = "SOURCE_CAPTURE" },
        { Severity = "LOGGER_SEVERITY_DEFAULT", Id = "SORTER" },
        { Severity = "LOGGER_SEVERITY_DEFAULT", Id = "REST_SERVER" },
        { Severity = "LOGGER_SEVERITY_DEFAULT", Id = "VALIDATOR_EXT" },
        { Severity = "LOGGER_SEVERITY_DEFAULT", Id = "TARGET_APPLY" },
        { Severity = "LOGGER_SEVERITY_DEFAULT", Id = "TASK_MANAGER" },
        { Severity = "LOGGER_SEVERITY_DEFAULT", Id = "TABLES_MANAGER" },
        { Severity = "LOGGER_SEVERITY_DEFAULT", Id = "METADATA_MANAGER" },
        { Severity = "LOGGER_SEVERITY_DEFAULT", Id = "FILE_FACTORY" },
        { Severity = "LOGGER_SEVERITY_DEFAULT", Id = "COMMON" },
        { Severity = "LOGGER_SEVERITY_DEFAULT", Id = "ADDONS" },
        { Severity = "LOGGER_SEVERITY_DEFAULT", Id = "DATA_STRUCTURE" },
        { Severity = "LOGGER_SEVERITY_DEFAULT", Id = "COMMUNICATION" },
        { Severity = "LOGGER_SEVERITY_DEFAULT", Id = "FILE_TRANSFER" }
      ]
    }
    StreamBufferSettings = {
      StreamBufferCount = 2
      CtrlStreamBufferSizeInMB = 16
      StreamBufferSizeInMB = 16
    }
    ErrorBehavior = {
      FailOnNoTablesCaptured = true
      ApplyErrorUpdatePolicy = "LOG_ERROR"
      FailOnTransactionConsistencyBreached = false
      RecoverableErrorThrottlingMax = 1800
      DataErrorEscalationPolicy = "SUSPEND_TABLE"
      ApplyErrorEscalationCount = 0
      RecoverableErrorStopRetryAfterThrottlingMax = true
      RecoverableErrorThrottling = true
      ApplyErrorFailOnTruncationDdl = false
      DataMaskingErrorPolicy = "STOP_TASK"
      DataTruncationErrorPolicy = "LOG_ERROR"
      ApplyErrorInsertPolicy = "LOG_ERROR"
      EventErrorPolicy = "IGNORE"
      ApplyErrorEscalationPolicy = "LOG_ERROR"
      RecoverableErrorCount = -1
      DataErrorEscalationCount = 0
      TableErrorEscalationPolicy = "STOP_TASK"
      RecoverableErrorInterval = 5
      ApplyErrorDeletePolicy = "IGNORE_RECORD"
      TableErrorEscalationCount = 0
      FullLoadIgnoreConflicts = true
      DataErrorPolicy = "LOG_ERROR"
      TableErrorPolicy = "SUSPEND_TABLE"
    }
    TTSettings = null
    FullLoadSettings = {
      CommitRate = 5000
      StopTaskCachedChangesApplied = false
      StopTaskCachedChangesNotApplied = false
      MaxFullLoadSubTasks = 4
      TransactionConsistencyTimeout = 600
      CreatePkAfterFullLoad = false
      TargetTablePrepMode = "DO_NOTHING"
    }
    TargetMetadata = {
      ParallelApplyBufferSize = 0
      ParallelApplyQueuesPerThread = 0
      ParallelApplyThreads = 0
      TargetSchema = ""
      InlineLobMaxSize = 0
      ParallelLoadQueuesPerThread = 0
      SupportLobs = true
      LobChunkSize = 0
      TaskRecoveryTableEnabled = false
      ParallelLoadThreads = 0
      LobMaxSize = 63
      BatchApplyEnabled = false
      FullLobMode = false
      LimitedSizeLobMode = true
      LoadMaxFileSize = 0
      ParallelLoadBufferSize = 0
    }
    BeforeImageSettings = null
    ControlTablesSettings = {
      historyTimeslotInMinutes = 5
      HistoryTimeslotInMinutes = 5
      StatusTableEnabled = false
      SuspendedTablesTableEnabled = false
      HistoryTableEnabled = false
      ControlSchema = ""
      FullLoadExceptionTableEnabled = false
    }
    LoopbackPreventionSettings = null
    CharacterSetSettings = null
    FailTaskWhenCleanTaskResourceFailed = false
    ChangeProcessingTuning = {
      StatementCacheSize = 50
      CommitTimeout = 1
      RecoveryTimeout = -1
      BatchApplyPreserveTransaction = true
      BatchApplyTimeoutMin = 1
      BatchSplitSize = 0
      BatchApplyTimeoutMax = 30
      MinTransactionSize = 1000
      MemoryKeepTime = 30
      BatchApplyMemoryLimit = 1024
      MemoryLimitTotal = 2048
    }
    ChangeProcessingDdlHandlingPolicy = {
      HandleSourceTableDropped = true
      HandleSourceTableTruncated = true
      HandleSourceTableAltered = true
    }
    PostProcessingRules = null
    TimestampColumnName = "edl_load_date"
  })

  tags = {
    Name         = "somggn-raw-cdc-migration-task"
    Environment  = var.environment
    Pod          = var.pod
    Businessunit = var.businessunit
  }
}

# DMS SOMGGN Raw Full Load Replication Task
resource "aws_dms_replication_task" "somggn_raw_full_migration" {
  migration_type           = "full-load"
  replication_instance_arn = data.aws_dms_replication_instance.main.replication_instance_arn
  replication_task_id      = "migration-task-esoms-ggn-raw-full"
  source_endpoint_arn      = aws_dms_endpoint.esom_ggn_oracle_source_endpoint.endpoint_arn
  target_endpoint_arn      = aws_dms_endpoint.s3_target_endpoint.endpoint_arn
  table_mappings           = local.somggn_raw_full_mappings

  replication_task_settings = jsonencode({
    Logging = {
      EnableLogging = true
      EnableLogContext = true
      LogComponents = [
        { Severity = "LOGGER_SEVERITY_DEFAULT", Id = "TRANSFORMATION" },
        { Severity = "LOGGER_SEVERITY_DEFAULT", Id = "SOURCE_UNLOAD" },
        { Severity = "LOGGER_SEVERITY_DEFAULT", Id = "IO" },
        { Severity = "LOGGER_SEVERITY_DEFAULT", Id = "TARGET_LOAD" },
        { Severity = "LOGGER_SEVERITY_DEFAULT", Id = "PERFORMANCE" },
        { Severity = "LOGGER_SEVERITY_DEFAULT", Id = "SOURCE_CAPTURE" },
        { Severity = "LOGGER_SEVERITY_DEFAULT", Id = "SORTER" },
        { Severity = "LOGGER_SEVERITY_DEFAULT", Id = "REST_SERVER" },
        { Severity = "LOGGER_SEVERITY_DEFAULT", Id = "VALIDATOR_EXT" },
        { Severity = "LOGGER_SEVERITY_DEFAULT", Id = "TARGET_APPLY" },
        { Severity = "LOGGER_SEVERITY_DEFAULT", Id = "TASK_MANAGER" },
        { Severity = "LOGGER_SEVERITY_DEFAULT", Id = "TABLES_MANAGER" },
        { Severity = "LOGGER_SEVERITY_DEFAULT", Id = "METADATA_MANAGER" },
        { Severity = "LOGGER_SEVERITY_DEFAULT", Id = "FILE_FACTORY" },
        { Severity = "LOGGER_SEVERITY_DEFAULT", Id = "COMMON" },
        { Severity = "LOGGER_SEVERITY_DEFAULT", Id = "ADDONS" },
        { Severity = "LOGGER_SEVERITY_DEFAULT", Id = "DATA_STRUCTURE" },
        { Severity = "LOGGER_SEVERITY_DEFAULT", Id = "COMMUNICATION" },
        { Severity = "LOGGER_SEVERITY_DEFAULT", Id = "FILE_TRANSFER" }
      ]
    }
    StreamBufferSettings = {
      StreamBufferCount = 2
      CtrlStreamBufferSizeInMB = 16
      StreamBufferSizeInMB = 16
    }
    ErrorBehavior = {
      FailOnNoTablesCaptured = true
      ApplyErrorUpdatePolicy = "LOG_ERROR"
      FailOnTransactionConsistencyBreached = false
      RecoverableErrorThrottlingMax = 1800
      DataErrorEscalationPolicy = "SUSPEND_TABLE"
      ApplyErrorEscalationCount = 0
      RecoverableErrorStopRetryAfterThrottlingMax = true
      RecoverableErrorThrottling = true
      ApplyErrorFailOnTruncationDdl = false
      DataMaskingErrorPolicy = "STOP_TASK"
      DataTruncationErrorPolicy = "LOG_ERROR"
      ApplyErrorInsertPolicy = "LOG_ERROR"
      EventErrorPolicy = "IGNORE"
      ApplyErrorEscalationPolicy = "LOG_ERROR"
      RecoverableErrorCount = -1
      DataErrorEscalationCount = 0
      TableErrorEscalationPolicy = "STOP_TASK"
      RecoverableErrorInterval = 5
      ApplyErrorDeletePolicy = "IGNORE_RECORD"
      TableErrorEscalationCount = 0
      FullLoadIgnoreConflicts = true
      DataErrorPolicy = "LOG_ERROR"
      TableErrorPolicy = "SUSPEND_TABLE"
    }
    TTSettings = null
    FullLoadSettings = {
      CommitRate = 5000
      StopTaskCachedChangesApplied = false
      StopTaskCachedChangesNotApplied = false
      MaxFullLoadSubTasks = 4
      TransactionConsistencyTimeout = 600
      CreatePkAfterFullLoad = false
      TargetTablePrepMode = "DROP_AND_CREATE"
    }
    TargetMetadata = {
      ParallelApplyBufferSize = 0
      ParallelApplyQueuesPerThread = 0
      ParallelApplyThreads = 0
      TargetSchema = ""
      InlineLobMaxSize = 0
      ParallelLoadQueuesPerThread = 0
      SupportLobs = true
      LobChunkSize = 0
      TaskRecoveryTableEnabled = false
      ParallelLoadThreads = 0
      LobMaxSize = 63
      BatchApplyEnabled = false
      FullLobMode = false
      LimitedSizeLobMode = true
      LoadMaxFileSize = 0
      ParallelLoadBufferSize = 0
    }
    BeforeImageSettings = null
    ControlTablesSettings = {
      historyTimeslotInMinutes = 5
      HistoryTimeslotInMinutes = 5
      StatusTableEnabled = false
      SuspendedTablesTableEnabled = false
      HistoryTableEnabled = false
      ControlSchema = ""
      FullLoadExceptionTableEnabled = false
    }
    LoopbackPreventionSettings = null
    CharacterSetSettings = null
    FailTaskWhenCleanTaskResourceFailed = false
    ChangeProcessingTuning = {
      StatementCacheSize = 50
      CommitTimeout = 1
      RecoveryTimeout = -1
      BatchApplyPreserveTransaction = true
      BatchApplyTimeoutMin = 1
      BatchSplitSize = 0
      BatchApplyTimeoutMax = 30
      MinTransactionSize = 1000
      MemoryKeepTime = 30
      BatchApplyMemoryLimit = 1024
      MemoryLimitTotal = 2048
    }
    ChangeProcessingDdlHandlingPolicy = {
      HandleSourceTableDropped = true
      HandleSourceTableTruncated = true
      HandleSourceTableAltered = true
    }
    PostProcessingRules = null
    TimestampColumnName = "edl_load_date"
  })

  tags = {
    Name         = "somggn-raw-full-migration-task"
    Environment  = var.environment
    Pod          = var.pod
    Businessunit = var.businessunit
  }
}

# DMS SOMRBS Raw CDC Replication Task
resource "aws_dms_replication_task" "somrbs_raw_cdc_migration" {
  migration_type           = "cdc"
  replication_instance_arn = data.aws_dms_replication_instance.main.replication_instance_arn
  replication_task_id      = "migration-task-esoms-rbs-raw-cdc"
  source_endpoint_arn      = aws_dms_endpoint.esom_rbs_oracle_source_endpoint.endpoint_arn
  target_endpoint_arn      = aws_dms_endpoint.s3_target_endpoint.endpoint_arn
  table_mappings           = local.somrbs_raw_cdc_mappings

  replication_task_settings = jsonencode({
    Logging = {
      EnableLogging = true
      EnableLogContext = true
      LogComponents = [
        { Severity = "LOGGER_SEVERITY_DEFAULT", Id = "TRANSFORMATION" },
        { Severity = "LOGGER_SEVERITY_DEFAULT", Id = "SOURCE_UNLOAD" },
        { Severity = "LOGGER_SEVERITY_DEFAULT", Id = "IO" },
        { Severity = "LOGGER_SEVERITY_DEFAULT", Id = "TARGET_LOAD" },
        { Severity = "LOGGER_SEVERITY_DEFAULT", Id = "PERFORMANCE" },
        { Severity = "LOGGER_SEVERITY_DEFAULT", Id = "SOURCE_CAPTURE" },
        { Severity = "LOGGER_SEVERITY_DEFAULT", Id = "SORTER" },
        { Severity = "LOGGER_SEVERITY_DEFAULT", Id = "REST_SERVER" },
        { Severity = "LOGGER_SEVERITY_DEFAULT", Id = "VALIDATOR_EXT" },
        { Severity = "LOGGER_SEVERITY_DEFAULT", Id = "TARGET_APPLY" },
        { Severity = "LOGGER_SEVERITY_DEFAULT", Id = "TASK_MANAGER" },
        { Severity = "LOGGER_SEVERITY_DEFAULT", Id = "TABLES_MANAGER" },
        { Severity = "LOGGER_SEVERITY_DEFAULT", Id = "METADATA_MANAGER" },
        { Severity = "LOGGER_SEVERITY_DEFAULT", Id = "FILE_FACTORY" },
        { Severity = "LOGGER_SEVERITY_DEFAULT", Id = "COMMON" },
        { Severity = "LOGGER_SEVERITY_DEFAULT", Id = "ADDONS" },
        { Severity = "LOGGER_SEVERITY_DEFAULT", Id = "DATA_STRUCTURE" },
        { Severity = "LOGGER_SEVERITY_DEFAULT", Id = "COMMUNICATION" },
        { Severity = "LOGGER_SEVERITY_DEFAULT", Id = "FILE_TRANSFER" }
      ]
    }
    StreamBufferSettings = {
      StreamBufferCount = 2
      CtrlStreamBufferSizeInMB = 16
      StreamBufferSizeInMB = 16
    }
    ErrorBehavior = {
      FailOnNoTablesCaptured = true
      ApplyErrorUpdatePolicy = "LOG_ERROR"
      FailOnTransactionConsistencyBreached = false
      RecoverableErrorThrottlingMax = 1800
      DataErrorEscalationPolicy = "SUSPEND_TABLE"
      ApplyErrorEscalationCount = 0
      RecoverableErrorStopRetryAfterThrottlingMax = true
      RecoverableErrorThrottling = true
      ApplyErrorFailOnTruncationDdl = false
      DataMaskingErrorPolicy = "STOP_TASK"
      DataTruncationErrorPolicy = "LOG_ERROR"
      ApplyErrorInsertPolicy = "LOG_ERROR"
      EventErrorPolicy = "IGNORE"
      ApplyErrorEscalationPolicy = "LOG_ERROR"
      RecoverableErrorCount = -1
      DataErrorEscalationCount = 0
      TableErrorEscalationPolicy = "STOP_TASK"
      RecoverableErrorInterval = 5
      ApplyErrorDeletePolicy = "IGNORE_RECORD"
      TableErrorEscalationCount = 0
      FullLoadIgnoreConflicts = true
      DataErrorPolicy = "LOG_ERROR"
      TableErrorPolicy = "SUSPEND_TABLE"
    }
    TTSettings = null
    FullLoadSettings = {
      CommitRate = 5000
      StopTaskCachedChangesApplied = false
      StopTaskCachedChangesNotApplied = false
      MaxFullLoadSubTasks = 4
      TransactionConsistencyTimeout = 600
      CreatePkAfterFullLoad = false
      TargetTablePrepMode = "DO_NOTHING"
    }
    TargetMetadata = {
      ParallelApplyBufferSize = 0
      ParallelApplyQueuesPerThread = 0
      ParallelApplyThreads = 0
      TargetSchema = ""
      InlineLobMaxSize = 0
      ParallelLoadQueuesPerThread = 0
      SupportLobs = true
      LobChunkSize = 0
      TaskRecoveryTableEnabled = false
      ParallelLoadThreads = 0
      LobMaxSize = 32
      BatchApplyEnabled = false
      FullLobMode = false
      LimitedSizeLobMode = true
      LoadMaxFileSize = 0
      ParallelLoadBufferSize = 0
    }
    BeforeImageSettings = null
    ControlTablesSettings = {
      historyTimeslotInMinutes = 5
      HistoryTimeslotInMinutes = 5
      StatusTableEnabled = false
      SuspendedTablesTableEnabled = false
      HistoryTableEnabled = false
      ControlSchema = ""
      FullLoadExceptionTableEnabled = false
    }
    LoopbackPreventionSettings = null
    CharacterSetSettings = null
    FailTaskWhenCleanTaskResourceFailed = false
    ChangeProcessingTuning = {
      StatementCacheSize = 50
      CommitTimeout = 1
      RecoveryTimeout = -1
      BatchApplyPreserveTransaction = true
      BatchApplyTimeoutMin = 1
      BatchSplitSize = 0
      BatchApplyTimeoutMax = 30
      MinTransactionSize = 1000
      MemoryKeepTime = 30
      BatchApplyMemoryLimit = 1024
      MemoryLimitTotal = 2048
    }
    ChangeProcessingDdlHandlingPolicy = {
      HandleSourceTableDropped = true
      HandleSourceTableTruncated = true
      HandleSourceTableAltered = true
    }
    PostProcessingRules = null
    TimestampColumnName = "edl_load_date"
  })

  tags = {
    Name         = "somrbs-raw-cdc-migration-task"
    Environment  = var.environment
    Pod          = var.pod
    Businessunit = var.businessunit
  }
}

# DMS SOMRBS Raw Full Load Replication Task
resource "aws_dms_replication_task" "somrbs_raw_full_migration" {
  migration_type           = "full-load"
  replication_instance_arn = data.aws_dms_replication_instance.main.replication_instance_arn
  replication_task_id      = "migration-task-esoms-rbs-raw-full"
  source_endpoint_arn      = aws_dms_endpoint.esom_rbs_oracle_source_endpoint.endpoint_arn
  target_endpoint_arn      = aws_dms_endpoint.s3_target_endpoint.endpoint_arn
  table_mappings           = local.somrbs_raw_full_mappings

  replication_task_settings = jsonencode({
    Logging = {
      EnableLogging = true
      EnableLogContext = true
      LogComponents = [
        { Severity = "LOGGER_SEVERITY_DEFAULT", Id = "TRANSFORMATION" },
        { Severity = "LOGGER_SEVERITY_DEFAULT", Id = "SOURCE_UNLOAD" },
        { Severity = "LOGGER_SEVERITY_DEFAULT", Id = "IO" },
        { Severity = "LOGGER_SEVERITY_DEFAULT", Id = "TARGET_LOAD" },
        { Severity = "LOGGER_SEVERITY_DEFAULT", Id = "PERFORMANCE" },
        { Severity = "LOGGER_SEVERITY_DEFAULT", Id = "SOURCE_CAPTURE" },
        { Severity = "LOGGER_SEVERITY_DEFAULT", Id = "SORTER" },
        { Severity = "LOGGER_SEVERITY_DEFAULT", Id = "REST_SERVER" },
        { Severity = "LOGGER_SEVERITY_DEFAULT", Id = "VALIDATOR_EXT" },
        { Severity = "LOGGER_SEVERITY_DEFAULT", Id = "TARGET_APPLY" },
        { Severity = "LOGGER_SEVERITY_DEFAULT", Id = "TASK_MANAGER" },
        { Severity = "LOGGER_SEVERITY_DEFAULT", Id = "TABLES_MANAGER" },
        { Severity = "LOGGER_SEVERITY_DEFAULT", Id = "METADATA_MANAGER" },
        { Severity = "LOGGER_SEVERITY_DEFAULT", Id = "FILE_FACTORY" },
        { Severity = "LOGGER_SEVERITY_DEFAULT", Id = "COMMON" },
        { Severity = "LOGGER_SEVERITY_DEFAULT", Id = "ADDONS" },
        { Severity = "LOGGER_SEVERITY_DEFAULT", Id = "DATA_STRUCTURE" },
        { Severity = "LOGGER_SEVERITY_DEFAULT", Id = "COMMUNICATION" },
        { Severity = "LOGGER_SEVERITY_DEFAULT", Id = "FILE_TRANSFER" }
      ]
    }
    StreamBufferSettings = {
      StreamBufferCount = 2
      CtrlStreamBufferSizeInMB = 16
      StreamBufferSizeInMB = 16
    }
    ErrorBehavior = {
      FailOnNoTablesCaptured = true
      ApplyErrorUpdatePolicy = "LOG_ERROR"
      FailOnTransactionConsistencyBreached = false
      RecoverableErrorThrottlingMax = 1800
      DataErrorEscalationPolicy = "SUSPEND_TABLE"
      ApplyErrorEscalationCount = 0
      RecoverableErrorStopRetryAfterThrottlingMax = true
      RecoverableErrorThrottling = true
      ApplyErrorFailOnTruncationDdl = false
      DataMaskingErrorPolicy = "STOP_TASK"
      DataTruncationErrorPolicy = "LOG_ERROR"
      ApplyErrorInsertPolicy = "LOG_ERROR"
      EventErrorPolicy = "IGNORE"
      ApplyErrorEscalationPolicy = "LOG_ERROR"
      RecoverableErrorCount = -1
      DataErrorEscalationCount = 0
      TableErrorEscalationPolicy = "STOP_TASK"
      RecoverableErrorInterval = 5
      ApplyErrorDeletePolicy = "IGNORE_RECORD"
      TableErrorEscalationCount = 0
      FullLoadIgnoreConflicts = true
      DataErrorPolicy = "LOG_ERROR"
      TableErrorPolicy = "SUSPEND_TABLE"
    }
    TTSettings = null
    FullLoadSettings = {
      CommitRate = 5000
      StopTaskCachedChangesApplied = false
      StopTaskCachedChangesNotApplied = false
      MaxFullLoadSubTasks = 4
      TransactionConsistencyTimeout = 600
      CreatePkAfterFullLoad = false
      TargetTablePrepMode = "DROP_AND_CREATE"
    }
    TargetMetadata = {
      ParallelApplyBufferSize = 0
      ParallelApplyQueuesPerThread = 0
      ParallelApplyThreads = 0
      TargetSchema = ""
      InlineLobMaxSize = 0
      ParallelLoadQueuesPerThread = 0
      SupportLobs = true
      LobChunkSize = 0
      TaskRecoveryTableEnabled = false
      ParallelLoadThreads = 0
      LobMaxSize = 32
      BatchApplyEnabled = false
      FullLobMode = false
      LimitedSizeLobMode = true
      LoadMaxFileSize = 0
      ParallelLoadBufferSize = 0
    }
    BeforeImageSettings = null
    ControlTablesSettings = {
      historyTimeslotInMinutes = 5
      HistoryTimeslotInMinutes = 5
      StatusTableEnabled = false
      SuspendedTablesTableEnabled = false
      HistoryTableEnabled = false
      ControlSchema = ""
      FullLoadExceptionTableEnabled = false
    }
    LoopbackPreventionSettings = null
    CharacterSetSettings = null
    FailTaskWhenCleanTaskResourceFailed = false
    ChangeProcessingTuning = {
      StatementCacheSize = 50
      CommitTimeout = 1
      RecoveryTimeout = -1
      BatchApplyPreserveTransaction = true
      BatchApplyTimeoutMin = 1
      BatchSplitSize = 0
      BatchApplyTimeoutMax = 30
      MinTransactionSize = 1000
      MemoryKeepTime = 30
      BatchApplyMemoryLimit = 1024
      MemoryLimitTotal = 2048
    }
    ChangeProcessingDdlHandlingPolicy = {
      HandleSourceTableDropped = true
      HandleSourceTableTruncated = true
      HandleSourceTableAltered = true
    }
    PostProcessingRules = null
    TimestampColumnName = "edl_load_date"
  })

  tags = {
    Name         = "somrbs-raw-full-migration-task"
    Environment  = var.environment
    Pod          = var.pod
    Businessunit = var.businessunit
  }
}

# DMS SOMWF3 Raw CDC Replication Task
resource "aws_dms_replication_task" "somwf3_raw_cdc_migration" {
  migration_type           = "cdc"
  replication_instance_arn = data.aws_dms_replication_instance.main.replication_instance_arn
  replication_task_id      = "migration-task-esoms-wf3-raw-cdc"
  source_endpoint_arn      = aws_dms_endpoint.esom_wf3_oracle_source_endpoint.endpoint_arn
  target_endpoint_arn      = aws_dms_endpoint.s3_target_endpoint.endpoint_arn
  table_mappings           = local.somwf3_raw_cdc_mappings

  replication_task_settings = jsonencode({
    Logging = {
      EnableLogging = true
      EnableLogContext = true
      LogComponents = [
        { Severity = "LOGGER_SEVERITY_DEFAULT", Id = "TRANSFORMATION" },
        { Severity = "LOGGER_SEVERITY_DEFAULT", Id = "SOURCE_UNLOAD" },
        { Severity = "LOGGER_SEVERITY_DEFAULT", Id = "IO" },
        { Severity = "LOGGER_SEVERITY_DEFAULT", Id = "TARGET_LOAD" },
        { Severity = "LOGGER_SEVERITY_DEFAULT", Id = "PERFORMANCE" },
        { Severity = "LOGGER_SEVERITY_DEFAULT", Id = "SOURCE_CAPTURE" },
        { Severity = "LOGGER_SEVERITY_DEFAULT", Id = "SORTER" },
        { Severity = "LOGGER_SEVERITY_DEFAULT", Id = "REST_SERVER" },
        { Severity = "LOGGER_SEVERITY_DEFAULT", Id = "VALIDATOR_EXT" },
        { Severity = "LOGGER_SEVERITY_DEFAULT", Id = "TARGET_APPLY" },
        { Severity = "LOGGER_SEVERITY_DEFAULT", Id = "TASK_MANAGER" },
        { Severity = "LOGGER_SEVERITY_DEFAULT", Id = "TABLES_MANAGER" },
        { Severity = "LOGGER_SEVERITY_DEFAULT", Id = "METADATA_MANAGER" },
        { Severity = "LOGGER_SEVERITY_DEFAULT", Id = "FILE_FACTORY" },
        { Severity = "LOGGER_SEVERITY_DEFAULT", Id = "COMMON" },
        { Severity = "LOGGER_SEVERITY_DEFAULT", Id = "ADDONS" },
        { Severity = "LOGGER_SEVERITY_DEFAULT", Id = "DATA_STRUCTURE" },
        { Severity = "LOGGER_SEVERITY_DEFAULT", Id = "COMMUNICATION" },
        { Severity = "LOGGER_SEVERITY_DEFAULT", Id = "FILE_TRANSFER" }
      ]
    }
    StreamBufferSettings = {
      StreamBufferCount = 2
      CtrlStreamBufferSizeInMB = 16
      StreamBufferSizeInMB = 16
    }
    ErrorBehavior = {
      FailOnNoTablesCaptured = true
      ApplyErrorUpdatePolicy = "LOG_ERROR"
      FailOnTransactionConsistencyBreached = false
      RecoverableErrorThrottlingMax = 1800
      DataErrorEscalationPolicy = "SUSPEND_TABLE"
      ApplyErrorEscalationCount = 0
      RecoverableErrorStopRetryAfterThrottlingMax = true
      RecoverableErrorThrottling = true
      ApplyErrorFailOnTruncationDdl = false
      DataMaskingErrorPolicy = "STOP_TASK"
      DataTruncationErrorPolicy = "LOG_ERROR"
      ApplyErrorInsertPolicy = "LOG_ERROR"
      EventErrorPolicy = "IGNORE"
      ApplyErrorEscalationPolicy = "LOG_ERROR"
      RecoverableErrorCount = -1
      DataErrorEscalationCount = 0
      TableErrorEscalationPolicy = "STOP_TASK"
      RecoverableErrorInterval = 5
      ApplyErrorDeletePolicy = "IGNORE_RECORD"
      TableErrorEscalationCount = 0
      FullLoadIgnoreConflicts = true
      DataErrorPolicy = "LOG_ERROR"
      TableErrorPolicy = "SUSPEND_TABLE"
    }
    TTSettings = null
    FullLoadSettings = {
      CommitRate = 5000
      StopTaskCachedChangesApplied = false
      StopTaskCachedChangesNotApplied = false
      MaxFullLoadSubTasks = 4
      TransactionConsistencyTimeout = 600
      CreatePkAfterFullLoad = false
      TargetTablePrepMode = "DO_NOTHING"
    }
    TargetMetadata = {
      ParallelApplyBufferSize = 0
      ParallelApplyQueuesPerThread = 0
      ParallelApplyThreads = 0
      TargetSchema = ""
      InlineLobMaxSize = 0
      ParallelLoadQueuesPerThread = 0
      SupportLobs = true
      LobChunkSize = 0
      TaskRecoveryTableEnabled = false
      ParallelLoadThreads = 0
      LobMaxSize = 32
      BatchApplyEnabled = false
      FullLobMode = false
      LimitedSizeLobMode = true
      LoadMaxFileSize = 0
      ParallelLoadBufferSize = 0
    }
    BeforeImageSettings = null
    ControlTablesSettings = {
      historyTimeslotInMinutes = 5
      HistoryTimeslotInMinutes = 5
      StatusTableEnabled = false
      SuspendedTablesTableEnabled = false
      HistoryTableEnabled = false
      ControlSchema = ""
      FullLoadExceptionTableEnabled = false
    }
    LoopbackPreventionSettings = null
    CharacterSetSettings = null
    FailTaskWhenCleanTaskResourceFailed = false
    ChangeProcessingTuning = {
      StatementCacheSize = 50
      CommitTimeout = 1
      RecoveryTimeout = -1
      BatchApplyPreserveTransaction = true
      BatchApplyTimeoutMin = 1
      BatchSplitSize = 0
      BatchApplyTimeoutMax = 30
      MinTransactionSize = 1000
      MemoryKeepTime = 30
      BatchApplyMemoryLimit = 1024
      MemoryLimitTotal = 2048
    }
    ChangeProcessingDdlHandlingPolicy = {
      HandleSourceTableDropped = true
      HandleSourceTableTruncated = true
      HandleSourceTableAltered = true
    }
    PostProcessingRules = null
    TimestampColumnName = "edl_load_date"
  })

  tags = {
    Name         = "somwf3-raw-cdc-migration-task"
    Environment  = var.environment
    Pod          = var.pod
    Businessunit = var.businessunit
  }
}

# DMS SOMWF3 Raw Full Load Replication Task
resource "aws_dms_replication_task" "somwf3_raw_full_migration" {
  migration_type           = "full-load"
  replication_instance_arn = data.aws_dms_replication_instance.main.replication_instance_arn
  replication_task_id      = "migration-task-esoms-wf3-raw-full"
  source_endpoint_arn      = aws_dms_endpoint.esom_wf3_oracle_source_endpoint.endpoint_arn
  target_endpoint_arn      = aws_dms_endpoint.s3_target_endpoint.endpoint_arn
  table_mappings           = local.somwf3_raw_full_mappings

  replication_task_settings = jsonencode({
    Logging = {
      EnableLogging = true
      EnableLogContext = true
      LogComponents = [
        { Severity = "LOGGER_SEVERITY_DEFAULT", Id = "TRANSFORMATION" },
        { Severity = "LOGGER_SEVERITY_DEFAULT", Id = "SOURCE_UNLOAD" },
        { Severity = "LOGGER_SEVERITY_DEFAULT", Id = "IO" },
        { Severity = "LOGGER_SEVERITY_DEFAULT", Id = "TARGET_LOAD" },
        { Severity = "LOGGER_SEVERITY_DEFAULT", Id = "PERFORMANCE" },
        { Severity = "LOGGER_SEVERITY_DEFAULT", Id = "SOURCE_CAPTURE" },
        { Severity = "LOGGER_SEVERITY_DEFAULT", Id = "SORTER" },
        { Severity = "LOGGER_SEVERITY_DEFAULT", Id = "REST_SERVER" },
        { Severity = "LOGGER_SEVERITY_DEFAULT", Id = "VALIDATOR_EXT" },
        { Severity = "LOGGER_SEVERITY_DEFAULT", Id = "TARGET_APPLY" },
        { Severity = "LOGGER_SEVERITY_DEFAULT", Id = "TASK_MANAGER" },
        { Severity = "LOGGER_SEVERITY_DEFAULT", Id = "TABLES_MANAGER" },
        { Severity = "LOGGER_SEVERITY_DEFAULT", Id = "METADATA_MANAGER" },
        { Severity = "LOGGER_SEVERITY_DEFAULT", Id = "FILE_FACTORY" },
        { Severity = "LOGGER_SEVERITY_DEFAULT", Id = "COMMON" },
        { Severity = "LOGGER_SEVERITY_DEFAULT", Id = "ADDONS" },
        { Severity = "LOGGER_SEVERITY_DEFAULT", Id = "DATA_STRUCTURE" },
        { Severity = "LOGGER_SEVERITY_DEFAULT", Id = "COMMUNICATION" },
        { Severity = "LOGGER_SEVERITY_DEFAULT", Id = "FILE_TRANSFER" }
      ]
    }
    StreamBufferSettings = {
      StreamBufferCount = 2
      CtrlStreamBufferSizeInMB = 16
      StreamBufferSizeInMB = 16
    }
    ErrorBehavior = {
      FailOnNoTablesCaptured = true
      ApplyErrorUpdatePolicy = "LOG_ERROR"
      FailOnTransactionConsistencyBreached = false
      RecoverableErrorThrottlingMax = 1800
      DataErrorEscalationPolicy = "SUSPEND_TABLE"
      ApplyErrorEscalationCount = 0
      RecoverableErrorStopRetryAfterThrottlingMax = true
      RecoverableErrorThrottling = true
      ApplyErrorFailOnTruncationDdl = false
      DataMaskingErrorPolicy = "STOP_TASK"
      DataTruncationErrorPolicy = "LOG_ERROR"
      ApplyErrorInsertPolicy = "LOG_ERROR"
      EventErrorPolicy = "IGNORE"
      ApplyErrorEscalationPolicy = "LOG_ERROR"
      RecoverableErrorCount = -1
      DataErrorEscalationCount = 0
      TableErrorEscalationPolicy = "STOP_TASK"
      RecoverableErrorInterval = 5
      ApplyErrorDeletePolicy = "IGNORE_RECORD"
      TableErrorEscalationCount = 0
      FullLoadIgnoreConflicts = true
      DataErrorPolicy = "LOG_ERROR"
      TableErrorPolicy = "SUSPEND_TABLE"
    }
    TTSettings = null
    FullLoadSettings = {
      CommitRate = 5000
      StopTaskCachedChangesApplied = false
      StopTaskCachedChangesNotApplied = false
      MaxFullLoadSubTasks = 4
      TransactionConsistencyTimeout = 600
      CreatePkAfterFullLoad = false
      TargetTablePrepMode = "DROP_AND_CREATE"
    }
    TargetMetadata = {
      ParallelApplyBufferSize = 0
      ParallelApplyQueuesPerThread = 0
      ParallelApplyThreads = 0
      TargetSchema = ""
      InlineLobMaxSize = 0
      ParallelLoadQueuesPerThread = 0
      SupportLobs = true
      LobChunkSize = 0
      TaskRecoveryTableEnabled = false
      ParallelLoadThreads = 0
      LobMaxSize = 32
      BatchApplyEnabled = false
      FullLobMode = false
      LimitedSizeLobMode = true
      LoadMaxFileSize = 0
      ParallelLoadBufferSize = 0
    }
    BeforeImageSettings = null
    ControlTablesSettings = {
      historyTimeslotInMinutes = 5
      HistoryTimeslotInMinutes = 5
      StatusTableEnabled = false
      SuspendedTablesTableEnabled = false
      HistoryTableEnabled = false
      ControlSchema = ""
      FullLoadExceptionTableEnabled = false
    }
    LoopbackPreventionSettings = null
    CharacterSetSettings = null
    FailTaskWhenCleanTaskResourceFailed = false
    ChangeProcessingTuning = {
      StatementCacheSize = 50
      CommitTimeout = 1
      RecoveryTimeout = -1
      BatchApplyPreserveTransaction = true
      BatchApplyTimeoutMin = 1
      BatchSplitSize = 0
      BatchApplyTimeoutMax = 30
      MinTransactionSize = 1000
      MemoryKeepTime = 30
      BatchApplyMemoryLimit = 1024
      MemoryLimitTotal = 2048
    }
    ChangeProcessingDdlHandlingPolicy = {
      HandleSourceTableDropped = true
      HandleSourceTableTruncated = true
      HandleSourceTableAltered = true
    }
    PostProcessingRules = null
    TimestampColumnName = "edl_load_date"
  })

  tags = {
    Name         = "somwf3-raw-full-migration-task"
    Environment  = var.environment
    Pod          = var.pod
    Businessunit = var.businessunit
  }
}
